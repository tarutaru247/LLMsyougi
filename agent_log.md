## 2025-11-27 再発防止ログ

### 事象
- `index.html` や `js/constants.js` が文字化けした状態でコミットされ、ブラウザ表示・JS実行が壊れた。
- 原因は前回の編集時に文字コードが壊れたまま保存され、UTF-8 ではないバイト列が混入したため。PowerShell経由で内容を確認せず、壊れたファイルを上書きしたことで被害が拡大した。

### 技術的原因
1. 文字コードの扱いを統一していなかった（UTF-8 BOM/UTF-16/Shift_JIS が混在）。
2. 書き換え前に `cat` などで確認した際に文字化けしていることに気付かず、そのままさらに置換処理を行った。
3. 自動置換スクリプトを複数回走らせ、既に破損したテキストに対して再置換したため、不可読文字が増殖した。
4. フロントの重要ファイル(index.html/constants.js)に対する変更を最小確認（ブラウザ表示/Node require）なしで進めた。

### 再発防止策
- **文字コード統一**: すべての編集・書き込みコマンドで `-Encoding UTF8` を明示する。新規ファイルも UTF-8 (BOMなし) 固定。
- **変更前後の健全性チェック**:
  - JSファイルは `node -c` または `node -e "require('./path')"` で構文エラー/文字化けがないか確認。
  - HTML は編集直後に `cat` で目視し、文字化けがないか確認。
- **自動置換の前にバックアップ**: 重要ファイルを置換する前に `copy file file.bak` を必ず取得し、破損時に即復旧できるようにする。
- **最終確認の義務化**: 重要リソース（index.html, constants.js）を変更した後は必ずブラウザで表示確認、コンソールエラー確認を行う。
- **置換対象の限定**: 正規表現置換は小さな範囲（API設定ブロックなど）に限定し、全体置換を避ける。広範囲置換が必要な場合は diff を確認してからコミット。
- **ログ記録**: 文字コード関連の事故が起きたら必ず agent_log.md に原因と対策を追記し、次回作業前に読む。

### ルール
1. フロントの基幹ファイルを触る前にバックアップ、触った後にブラウザ確認。
2. 文字化けを一度でも見たら必ずファイルを UTF-8 で再保存してから作業を続行。
3. 自動置換を連続実行しない。置換→確認→次の置換、の順に進める。

