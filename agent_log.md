## 2025-11-27 トラブルログ

### 概要
- `index.html` と `js/constants.js` を誤った文字コードで保存しコミット。ブラウザ表示・JS実行に失敗。
- 以降の作業で誤コードが上書き保存され、UTF-8 ではないバイト列が混入。PowerShell出力で文字化けを確認。

### 再発防止策
1. 文字コードは必ず UTF-8 (BOMなし)。閲覧・編集コマンドは `-Encoding UTF8` を明示。
2. 保存前後に簡易確認：HTML は cat、JS は `node -c` または `node -e "require('./path')"` でエラーがないかチェック。
3. 重要ファイル（index.html / constants.js）変更前に即席バックアップ（例: `copy index.html index.html.bak`）。
4. 保存後はブラウザ/コンソールで最終確認してからコミット。
5. コミット前に diff を目視し、意図しない文字化けがないか確認。
6. エラー発生時や作業メモは必ず agent_log.md に追記。

### 今回新たに発覚した状態と対応方針
- 対局停止ボタンが未配線、ランダムに動くダミーモデルが未実装。
- モード「生成AI vs 生成AI」は自動開始禁止（開始は手動ボタンのみ）。
- ヘッダーのボタン文言など一部が文字化けしている疑い。

対応計画（次にやること）
1. 文字化け修正：`index.html` の各ボタン文言を UTF-8 正常化。
2. 停止フラグ導入：`Game` に stopRequested を追加し、makeBotMove/コールバックで中断判定。`stopAiMatch()` でフラグON＆思考表示クリア。
3. 停止ボタン配線：`UI` で stop ボタン → `game.stopAiMatch()` を呼ぶ。
4. ランダムダミーモデル：`constants.js` に DEBUG_DUMMY_RANDOM（isRandom:true）追加。`Bot` で API を呼ばず合法手からランダム選択＋約1秒ディレイで返す。
5. 自動開始なしを再確認し、`startAiMatch` は手動開始のみ。
6. 動作確認：人間vsAI / AI同士（ランダム×ランダム）で開始→1秒刻みで進行、停止ボタンで中断できることを確認。

## 2025-11-28 実装作業ログ

### 実装内容：AI思考モードの選択機能追加
ユーザーの要望により、LLMに合法手リストから選択させる「選択式」に加え、自力で手を生成させる「生成式」モードを追加した。既存の仕様は維持しつつ、設定画面でモードを切り替えられるようにした。

1. **設定機能の拡張**:
   - `js/settings.js`: `botThinkingMode` プロパティ（`select` | `generate`）を追加。
   - `index.html`: 設定モーダルに思考モード選択用のラジオボタンを追加。
   - `js/ui.js`: 設定の読み込み・保存時にラジオボタンの値を反映・保存する処理を追加。

2. **Botロジックの追加**:
   - `js/bot.js`: `generateMoveWithLLM` メソッドを追加。合法手リストを含まないプロンプトを生成し、LLMに標準棋譜形式（`notation`）での回答を求める。
   - `createPromptForGenerativeMode`: 生成モード専用のプロンプト生成メソッド。
   - 回答の検証には既存の `extractMoveFromResponse` を利用し、生成された手が現在の合法手リストと一致するかチェックすることで反則判定を行う。

3. **Gameロジックの改修**:
   - `js/game.js`: `makeBotMove` 内で `settings.botThinkingMode` を参照し、モードに応じて `selectMoveWithLLM` または `generateMoveWithLLM` を呼び分けるよう変更。
   - 生成モードで非合法手（解釈不能または反則手）が返された場合、エラーを表示して対局を停止させる（ユーザーがやり直しを選択できる状態にする）。

### 修正対応：生成式モードでのマッチング改善
AIが生成する「３四歩」のような標準的な棋譜表記（移動元座標を含まない）が、システム内部の詳細な棋譜表記（移動元座標を含む）と一致せず、合法手であるにもかかわらずエラーとなる問題が発生した。

対応として `js/bot.js` を修正：
1. `Bot.createSimpleNotation` メソッドを追加。移動先と駒名のみの簡易表記（例: `７六歩`）を生成可能にした。
2. `Bot.extractMoveFromResponse` を改修。
   - 合法手リストの照合において、従来の完全一致（移動元含む）に加え、この簡易表記（`simpleNorm`）での照合も行うようにした。
   - これにより、AIが「３四歩」と答えた場合でも、合法手リスト内の「３三歩３四（33から34へ歩が移動）」などの手と正しくマッチングされるようになった。

### 追加機能：再生成ボタンの実装
AIが反則手やエラーを返して停止した際、ユーザーが即座にリトライできるようにした。

1. `js/game.js`: `retryBotMove` メソッドを追加。思考状態をリセットし、`makeBotMove` を再呼び出しする。
2. `js/ui.js`: `handleAiError` を改修し、エラーメッセージの下に「再生成する」ボタンを表示するようにした。ボタン押下時に `retryBotMove` が実行される。

### UI改善：設定画面のレイアウト変更
思考モードの選択項目を、APIキー設定エリアからモデル選択エリア（設定モーダル上部）へ移動させた。
（追記：この変更により、メイン画面に常駐していたモデル選択が消える問題が発生したため、さらに修正を行った）

### UI修正：モデル選択・思考モード設定の常駐化
「設定モーダルを開閉するとモデル選択が消える」という問題を解決するため、UI生成ロジックを見直した。

1. `index.html`: 設定モーダル内に追加していたコンテナ（`modelSettingsContainer`）を削除。
2. `js/ui.js`: 設定モーダルを開くたびにUIを再生成（移動）させていた処理を削除。
3. `js/settings.js`: `createModelSelector` を修正し、ヘッダー内に収まりやすい横並びレイアウト（Flexbox）に変更。「思考モード」のラジオボタンもここに統合し、常時表示されるようにした。

### UI修正：設定項目の配置場所移動
ヘッダー（タイトル横）に設定項目を詰め込むとレイアウトが崩れるため、ヘッダーの下に独立した設定バーを設けた。

1. `index.html`: `<header>` の直下に `<div id="modelSettingsBar">` を追加。
2. `css/style.css`: `.settings-bar` のスタイルを追加（白背景、枠線付き、Flexboxレイアウト）。
3. `js/main.js`: モデルセレクタ（`createModelSelector`）の生成先をヘッダー内の `.game-controls` から新設の `modelSettingsBar` に変更。
4. `js/settings.js`: `createModelSelector` 内のスタイルを調整し、横一列に見やすく並ぶように修正。説明文も復活させ、項目の横に配置。

### 改善対応：生成式モードの盤面伝達精度の向上
生成式モードにおいて、AIが盤面を正確に把握できていない（幻の手を指すなど）問題に対処するため、プロンプトに含める盤面情報の形式を強化した。

1. **SFEN文字列の追加**:
   - `js/bot.js` に `generateSFEN` メソッドを追加。盤面配置を標準的なSFEN (USI) 形式の文字列で生成するようにした（例: `lnsgkgsnl/1r5b1/ppppppppp/...`）。これにより、将棋の学習データを持つLLMが盤面を認識しやすくなる。

2. **テキストグリッド（ASCIIアート）の追加**:
   - `js/bot.js` に `generateAsciiBoard` メソッドを追加。盤面を視覚的なテキストグリッド（`|香|桂|...`）で表現するようにした。これは画像認識が不十分な場合や、テキストのみで推論する場合の補助となる。

3. **プロンプトの更新**:
   - `createPromptForGenerativeMode` を修正し、従来のJSON形式の盤面データの代わりに、このSFEN文字列とテキストグリッドを使用するように変更した。

### 修正対応：「同歩」などの表記対応
AIが「同歩」「同銀」といった「同」を含む手を返した際、正規化ロジックが対応しておらずエラーになっていた。

1. `js/bot.js`: `createSimpleNotation` メソッドを拡張し、直前の指し手の移動先と同じ場合は「同」を使った表記も生成するように修正。
2. `extractMoveFromResponse`: 直前の指し手（`gameHistory`）を参照し、`createSimpleNotation` に渡すように変更。これにより、「同歩」も合法手リスト内の適切な手とマッチングされるようになった。

### 修正対応：「打」の省略対応
AIが「７六歩打」ではなく「７六歩」と、「打」を省略して返す場合があり、その際にエラーになっていた。

1. `js/bot.js`: `extractMoveFromResponse` メソッドを修正。合法手リストの各手に対し、それが「打つ手（drop）」である場合、「打」を除去した表記（例：「７六歩」）も照合用の正規化データ（`dropNorm`）として保持するようにした。
2. マッチング処理において、完全一致・簡易一致で見つからない場合、この `dropNorm` での検索も行うようにロジックを追加した。

### 確認事項
- 生成式モードで、AIが「５五角」（持ち駒からの場合）のように「打」を省略しても、正しく「５五角打」として認識され、指し手が進むか。

## 2025-11-29 実装作業ログ

### 実装内容：ダークモードの実装
ユーザーの要望により、画面上部のボタンでダークモードとライトモードを切り替えられるようにした。

1. **`js/settings.js` の修正**:
   - `darkMode` プロパティを追加し、`loadSettings`, `saveSettings` で永続化。
   - `setDarkMode`, `getDarkMode` メソッドを追加。

2. **`index.html` の修正**:
   - ヘッダーの `.game-controls` 内にダークモード切り替えボタン (`#darkModeBtn`) を追加。

3. **`css/style.css` の修正**:
   - `body.dark-mode` を起点としたダークモード用のスタイル変数を追加。
   - 各コンポーネント（盤面外周、棋譜、思考ログ、モーダルなど）の配色を調整。

4. **`js/ui.js` の修正**:
   - `darkModeBtn` のクリックイベントハンドラを実装。
   - 設定値に基づいて `body` クラスをトグルし、ボタンのアイコン（🌙/☀️）を切り替える処理を追加。
   - ページ読み込み時に設定を反映するように初期化処理を追加。
